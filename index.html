<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>App Visitas (Toyo MX)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffffcc; --text:#0f172a; --muted:rgba(15,23,42,.62);
      --line:rgba(15,23,42,.10); --shadow:0 10px 30px rgba(15,23,42,.10);
      --shadow2:0 6px 18px rgba(15,23,42,.10); --radius:18px;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.16), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(20,184,166,.12), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 90px}
    header{
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(246,247,251,.92), rgba(246,247,251,.55));
      border-bottom:1px solid var(--line);
    }
    .top{
      max-width:980px;margin:0 auto;
      padding:12px 12px 10px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:flex-start;min-width:240px;}
    .pillLogo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(20,184,166,.95));
      box-shadow: var(--shadow2);
      flex:0 0 auto;
    }
    .brand h1{margin:0;font-size:15px;letter-spacing:.2px}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .nav{display:flex;gap:10px;align-items:center;flex: 1 1 auto;justify-content:flex-end;min-width:260px;}
    .pills{display:flex;gap:10px;align-items:center;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:2px;}
    .pills::-webkit-scrollbar{height:6px}
    .pill{
      border:1px solid var(--line); background: rgba(255,255,255,.78);
      padding:10px 12px; border-radius:999px;
      font-weight:800; font-size:13px; cursor:pointer;
      box-shadow: 0 6px 14px rgba(15,23,42,.06);
      white-space:nowrap; user-select:none;
      transition: transform .08s ease, background .15s ease;
    }
    .pill:active{transform:translateY(1px)}
    .pill.active{
      background: linear-gradient(135deg, rgba(99,102,241,.18), rgba(20,184,166,.14));
      border-color: rgba(99,102,241,.30);
    }
    .routeSelect{
      display:none; width:100%;
      padding:12px 12px; border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color: rgba(15,23,42,.92);
      font-weight:800; box-shadow: 0 8px 18px rgba(15,23,42,.08);
      appearance:none;-webkit-appearance:none;
    }
    @media (max-width: 560px){
      .nav{justify-content:stretch}
      .pills{display:none}
      .routeSelect{display:block}
    }
    .statusBar{max-width:980px;margin:0 auto;padding:0 12px 10px;}
    .statusCard{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.78);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      flex-wrap:wrap;
    }
    .statusLeft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.18)}
    .dot.good{background:var(--good);box-shadow:0 0 0 4px rgba(22,163,74,.18)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(239,68,68,.14)}
    .statusText{font-size:12px;color:var(--muted)}
    .statusRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .miniTag{font-size:12px;font-weight:800;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.84);}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:14px;margin-top:12px}
    @media(max-width: 860px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);background: rgba(255,255,255,.82);border-radius: var(--radius);box-shadow: var(--shadow);overflow:hidden;}
    .card .hd{padding:14px 14px 10px;display:flex;gap:10px;align-items:flex-start;justify-content:space-between;border-bottom:1px solid var(--line);}
    .card .hd h2{margin:0;font-size:14px}
    .card .hd p{margin:3px 0 0;font-size:12px;color:var(--muted)}
    .card .bd{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      outline:none; font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.two{grid-template-columns:1fr}}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid rgba(15,23,42,.14); background: rgba(255,255,255,.90);
      padding:11px 12px;border-radius: 14px; font-weight:900;font-size:13px;
      cursor:pointer;user-select:none; box-shadow: 0 10px 18px rgba(15,23,42,.06);
    }
    .btn.primary{border-color: rgba(99,102,241,.25); background: linear-gradient(135deg, rgba(99,102,241,.16), rgba(20,184,166,.12));}
    .btn.good{border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.10);}
    .btn.bad{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10);}
    .btn:active{transform:translateY(1px)}
    .note{margin-top:10px;padding:10px 12px;border-radius: 14px;border:1px dashed rgba(15,23,42,.16);background: rgba(255,255,255,.75);font-size:12px;color: rgba(15,23,42,.70);}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);background: rgba(255,255,255,.88);border-radius: 16px;padding:12px;box-shadow: 0 10px 18px rgba(15,23,42,.05);}
    .itemTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .itemTop b{font-size:13px}
    .meta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}
    .links{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .link{font-size:12px;font-weight:900;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.92);text-decoration:none;color:var(--text);}
    .split{height:1px;background:var(--line);margin:12px 0}
    .fabAdmin{
      position:fixed; right:14px;bottom:14px;z-index:9999;
      border:0;border-radius:999px; padding:12px 14px; font-weight:900;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
      background:rgba(255,255,255,.92); backdrop-filter: blur(10px);
    }
    .fabAdmin:active{transform:translateY(1px)}
    .overlay{position:fixed;inset:0;z-index:99999;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:16px;}
    .modal{width:min(420px, 100%);border-radius: 22px;background: rgba(255,255,255,.94);border:1px solid rgba(255,255,255,.40);box-shadow: 0 28px 70px rgba(2,6,23,.35);overflow:hidden;}
    .modal .mhd{padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal .mhd h3{margin:0;font-size:14px}
    .modal .mhd p{margin:4px 0 0;font-size:12px;color:var(--muted)}
    .modal .mbd{padding:14px 16px}
    .modal .mft{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .hide{display:none}
    .toast{position:fixed;left:12px;right:12px;bottom:78px;z-index:100000;display:flex;justify-content:center;pointer-events:none;}
    .toast .tcard{pointer-events:auto;max-width:980px;width:100%;border-radius:16px;border:1px solid rgba(15,23,42,.12);background: rgba(255,255,255,.90);box-shadow:0 14px 30px rgba(2,6,23,.16);padding:10px 12px;display:flex;gap:10px;align-items:flex-start;justify-content:space-between;}
    .toast b{font-size:13px}
    .toast p{margin:2px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
    .toast .x{border:0;background:transparent;font-weight:900;cursor:pointer}
  </style>
</head>
<body>

<header>
  <div class="top">
    <div class="brand">
      <div class="pillLogo"></div>
      <div>
        <h1>App de Visitas (Toyo MX)</h1>
        <p>Un solo <b>index.html</b> · tiempo + ubicación · cola offline → cloud · Admin con PIN</p>
      </div>
    </div>

    <div class="nav">
      <select id="routeSelectMobile" class="routeSelect" aria-label="Seleccionar ciudad o Admin"></select>
      <div class="pills" aria-label="Rutas">
        <div class="pill" data-route="#/gdl">Guadalajara</div>
        <div class="pill" data-route="#/mty">Monterrey</div>
        <div class="pill" data-route="#/mex">México</div>
        <div class="pill admin" data-route="#/admin">Admin</div>
      </div>
    </div>
  </div>

  <div class="statusBar">
    <div class="statusCard">
      <div class="statusLeft">
        <div id="netDot" class="dot"></div>
        <div>
          <div style="font-weight:900;font-size:13px" id="netTitle">Estado</div>
          <div class="statusText" id="netSubtitle">—</div>
        </div>
      </div>
      <div class="statusRight">
        <div class="miniTag" id="cloudTag">Cloud: —</div>
        <div class="miniTag" id="pendingTag">Pendientes: 0</div>
        <div class="miniTag" id="lastTag">Último envío: —</div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="page-city">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h2 id="cityTitle">Ciudad</h2>
            <p>Selecciona vendedor → cliente → tipo → <b>Iniciar</b> → <b>Terminar</b>.</p>
          </div>
          <button class="btn" id="btnExample">Cargar ejemplo</button>
        </div>
        <div class="bd">
          <label>Vendedor</label>
          <select id="seller"></select>

          <div class="two">
            <div>
              <label>Fecha (historial)</label>
              <input id="day" type="date"/>
            </div>
            <div>
              <label>Selección de visita</label>
              <select id="vtype">
                <option value="">Selecciona un tipo…</option>
                <option>Degustación</option>
                <option>Entrega de faltantes</option>
                <option>Entrega de nuevos productos</option>
                <option>Visita Potencialidad</option>
                <option>Visita de Seguimiento</option>
                <option>Cobranza</option>
              </select>
            </div>
          </div>

          <label>Cliente a visitar</label>
          <input id="client" placeholder="Ej. Sushi Beto"/>

          <label>Comentarios</label>
          <textarea id="notes" placeholder="Notas rápidas: acuerdos, faltantes, próximos pasos…"></textarea>

          <div class="btnrow">
            <button class="btn good" id="btnStart">Iniciar visita</button>
            <button class="btn bad" id="btnEnd" disabled>Terminar visita</button>
            <button class="btn" id="btnSync">Sincronizar pendientes</button>
          </div>

          <div class="note" id="activeBox">
            <b>Estado:</b> <span id="activeState">Sin visita activa</span><br/>
            <span class="statusText" id="activeMeta">—</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2>Historial del día</h2>
            <p id="histSubtitle">—</p>
          </div>
          <button class="btn" id="btnClearLocal">Limpiar local</button>
        </div>
        <div class="bd">
          <div class="list" id="histList"></div>
          <div class="split"></div>
          <div>
            <h2 style="font-size:14px;margin:0 0 6px">Mapa rápido</h2>
            <p class="statusText" style="margin:0 0 8px">Abre cada pin en Google Maps.</p>
            <div class="list" id="pinsList"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="page-admin" class="hide">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Admin (local)</h2>
            <p>Revisión local del dispositivo: filtros por ciudad, vendedor y rango de fechas.</p>
          </div>
          <button class="btn" id="btnLock">Bloquear</button>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <label>Ciudad</label>
              <select id="admCity">
                <option value="ALL">Todas</option>
                <option value="gdl">Guadalajara</option>
                <option value="mty">Monterrey</option>
                <option value="mex">México</option>
              </select>
            </div>
            <div>
              <label>Vendedor</label>
              <select id="admSeller"><option value="ALL">Todos</option></select>
            </div>
          </div>
          <div class="two">
            <div>
              <label>Desde</label>
              <input id="admFrom" type="date"/>
            </div>
            <div>
              <label>Hasta</label>
              <input id="admTo" type="date"/>
            </div>
          </div>
          <div class="btnrow">
            <button class="btn primary" id="btnAdmApply">Aplicar</button>
            <button class="btn" id="btnExport">Exportar JSON</button>
            <button class="btn bad" id="btnResetPin">Cambiar PIN</button>
          </div>
          <div class="note">
            Cloud está <b>solo para subir</b>. Admin lee local, no requiere SELECT en Supabase.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2>Resultados</h2>
            <p id="admSubtitle">—</p>
          </div>
          <button class="btn" id="btnOpenAllPins">Abrir pin</button>
        </div>
        <div class="bd">
          <div class="list" id="admList"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<button id="fabAdmin" class="fabAdmin">Admin</button>

<div id="pinOverlay" class="overlay">
  <div class="modal">
    <div class="mhd">
      <h3>Acceso Admin</h3>
      <p>Ingresa tu PIN para abrir la sección Admin.</p>
    </div>
    <div class="mbd">
      <label>PIN</label>
      <input id="pinInput" type="password" inputmode="numeric" placeholder="••••"/>
      <div class="note">PIN por defecto: <b>1234</b>. Puedes cambiarlo desde Admin.</div>
    </div>
    <div class="mft">
      <button class="btn" id="pinCancel">Cancelar</button>
      <button class="btn primary" id="pinUnlock">Entrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast" style="display:none">
  <div class="tcard">
    <div>
      <b id="toastTitle">—</b>
      <p id="toastMsg">—</p>
    </div>
    <button class="x" id="toastClose">✕</button>
  </div>
</div>

<script>
/* =============================
   CONFIG (PEGA AQUI TUS DATOS)
   ============================= */
const SUPABASE_PROJECT_URL = "PEGA_AQUI_TU_PROJECT_URL"; // ej: https://xxxx.supabase.co
const SUPABASE_ANON_KEY    = "PEGA_AQUI_TU_ANON_KEY";    // ej: eyJ...
const SUPABASE_TABLE       = "visits";
const ADMIN_READS_FROM_SUPABASE = false; // Admin local
/* ============================= */

const STORE_KEY="toyo_visits_store_v1", ACTIVE_KEY="toyo_visits_active_v1", PENDING_KEY="toyo_visits_pending_v1";
const DEVICE_KEY="toyo_visits_device_id_v1", PIN_HASH_KEY="toyo_visits_admin_pin_hash_v1", ADMIN_UNLOCK_KEY="toyo_visits_admin_unlock_until_v1";
const $=(q)=>document.querySelector(q), $$=(q)=>Array.from(document.querySelectorAll(q));
const elCityTitle=$("#cityTitle"), elSeller=$("#seller"), elDay=$("#day"), elClient=$("#client"), elType=$("#vtype"), elNotes=$("#notes");
const elBtnStart=$("#btnStart"), elBtnEnd=$("#btnEnd"), elBtnExample=$("#btnExample"), elBtnSync=$("#btnSync");
const elActiveState=$("#activeState"), elActiveMeta=$("#activeMeta"), elHistList=$("#histList"), elPinsList=$("#pinsList"), elHistSubtitle=$("#histSubtitle");
const elBtnClearLocal=$("#btnClearLocal"), elRouteSelectMobile=$("#routeSelectMobile"), elPageCity=$("#page-city"), elPageAdmin=$("#page-admin");
const elNetDot=$("#netDot"), elNetTitle=$("#netTitle"), elNetSubtitle=$("#netSubtitle"), elCloudTag=$("#cloudTag"), elPendingTag=$("#pendingTag"), elLastTag=$("#lastTag");
const elFabAdmin=$("#fabAdmin"), elPinOverlay=$("#pinOverlay"), elPinInput=$("#pinInput"), elPinCancel=$("#pinCancel"), elPinUnlock=$("#pinUnlock");
const elAdmCity=$("#admCity"), elAdmSeller=$("#admSeller"), elAdmFrom=$("#admFrom"), elAdmTo=$("#admTo"), elBtnAdmApply=$("#btnAdmApply"), elBtnExport=$("#btnExport");
const elAdmList=$("#admList"), elAdmSubtitle=$("#admSubtitle"), elBtnOpenAllPins=$("#btnOpenAllPins"), elBtnLock=$("#btnLock"), elBtnResetPin=$("#btnResetPin");
const TOAST=$("#toast"), TOAST_TITLE=$("#toastTitle"), TOAST_MSG=$("#toastMsg"); $("#toastClose").addEventListener("click", ()=>TOAST.style.display="none");
function toast(t,m){TOAST_TITLE.textContent=t||"Info";TOAST_MSG.textContent=m||"";TOAST.style.display="flex";setTimeout(()=>TOAST.style.display="none",3600)}
function safeJsonParse(s,f){try{return JSON.parse(s)}catch(e){return f}}
function getDeviceId(){let id=localStorage.getItem(DEVICE_KEY); if(!id){id=(crypto.randomUUID?crypto.randomUUID():String(Date.now())+"-"+Math.random().toString(16).slice(2)); localStorage.setItem(DEVICE_KEY,id)} return id}
function localDateKey(d){const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);return z.toISOString().slice(0,10)}
function fmtTime(ts){if(!ts)return "—";const d=new Date(ts);return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`}
function fmtDur(sec){if(sec==null)return "—";sec=Math.max(0,sec|0);const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`}
function escapeHtml(s){return String(s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]))}

const SELLERS={
  mex:["David Adrian Hernández Guzmán","Javier Espinosa Olivares","Ricardo Gutierrez Bandera","Abraham Rene Valdes Gonzales","Jesus Antonio Ramirez Rivera","Sergio Servin Rivera","Eduardo Faustino Hernandez Sanchez","Andres Fierro Ibañez","Tohru Kurasawa","Tanno Nobuko"],
  mty:["Jessica Palomo","Luis Heredia","Carla Hernández"],
  gdl:["Aguilar Neri Daniel","De la Cruz Ponce Julio Cesar","Garibay Ortiz Sergio Joel","Sierra de Anda Aldo","Perez Mar Alan Roberto","Reynoso Aguilar Maricela","Sandra Navarro Navarro","Aguirre Ojeda Arcenio","Velez Castellanos Antonio","Yepez Mora Oscar Alberto","Sanchez Esmeralda","Reynaga Valeria","González Guzmán Cristian Eduardo"]
};

let currentRoute="#/gdl", currentCityKey="gdl", activeTimer=null;

function loadStore(){return safeJsonParse(localStorage.getItem(STORE_KEY),{visits:[]})}
function saveStore(s){localStorage.setItem(STORE_KEY,JSON.stringify(s))}
function loadActive(){return safeJsonParse(localStorage.getItem(ACTIVE_KEY),null)}
function saveActive(o){localStorage.setItem(ACTIVE_KEY,JSON.stringify(o))}
function clearActive(){localStorage.removeItem(ACTIVE_KEY)}
function loadPending(){return safeJsonParse(localStorage.getItem(PENDING_KEY),[])}
function savePending(l){localStorage.setItem(PENDING_KEY,JSON.stringify(l))}
function addPending(rec){const l=loadPending();const id=rec.local_id||rec.id;if(!id)return;if(l.some(x=>(x.local_id||x.id)===id))return;l.push(rec);savePending(l)}
function removePending(id){savePending(loadPending().filter(x=>(x.local_id||x.id)!==id))}
function setLastSent(iso){localStorage.setItem("toyo_last_sent_v1",iso)}
function getLastSent(){return localStorage.getItem("toyo_last_sent_v1")||""}

function cloudConfigured(){
  return !!(SUPABASE_PROJECT_URL && SUPABASE_ANON_KEY &&
    !SUPABASE_PROJECT_URL.includes("PEGA_AQUI") && !SUPABASE_ANON_KEY.includes("PEGA_AQUI"));
}
function restUrl(p){return SUPABASE_PROJECT_URL.replace(/\/$/,"")+p}
async function upsertVisit(rec){
  if(!cloudConfigured()) return {ok:false,msg:"No configurado"};
  const url=restUrl(`/rest/v1/${encodeURIComponent(SUPABASE_TABLE)}?on_conflict=local_id,device_id`);
  const headers={
    "Content-Type":"application/json",
    "apikey":SUPABASE_ANON_KEY,
    "Authorization":"Bearer "+SUPABASE_ANON_KEY,
    "Prefer":"resolution=merge-duplicates,return=minimal"
  };
  const row={
    local_id:rec.local_id, device_id:rec.device_id, city:rec.city, vendor:rec.vendor, client:rec.client,
    type:rec.type, notes:rec.notes||"", day_key:rec.day_key,
    start_ts:rec.start_ts, start_lat:rec.start_lat, start_lng:rec.start_lng,
    end_ts:rec.end_ts, end_lat:rec.end_lat, end_lng:rec.end_lng,
    duration_sec:rec.duration_sec
  };
  const res=await fetch(url,{method:"POST",headers,body:JSON.stringify([row])});
  if(res.ok) return {ok:true};
  let msg=`HTTP ${res.status}`; try{const t=await res.text(); if(t&&t.length<240) msg=t}catch(e){}
  return {ok:false,msg};
}
async function syncPending(){
  const list=loadPending();
  if(!list.length){toast("Cloud","No hay pendientes"); updateStatus(); return;}
  if(!cloudConfigured()){toast("Cloud","Falta pegar Project URL y Anon Key en el index.html"); updateStatus(); return;}
  let ok=0, fail=0;
  for(const rec of list){
    const r=await upsertVisit(rec);
    if(r.ok){removePending(rec.local_id||rec.id);ok++;setLastSent(new Date().toISOString())} else {fail++}
  }
  toast("Cloud",`Sincronización: ${ok} OK · ${fail} fallaron`);
  updateStatus();
}

async function sha256Hex(msg){
  const enc=new TextEncoder().encode(msg);
  const buf=await crypto.subtle.digest("SHA-256",enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function ensureDefaultPin(){
  if(localStorage.getItem(PIN_HASH_KEY)) return;
  localStorage.setItem(PIN_HASH_KEY, await sha256Hex("1234"));
}
function unlockedUntil(){const n=parseInt(sessionStorage.getItem(ADMIN_UNLOCK_KEY)||"0",10);return isFinite(n)?n:0}
function getUnlocked(){return Date.now()<unlockedUntil()}
function setUnlocked(min){sessionStorage.setItem(ADMIN_UNLOCK_KEY,String(Date.now()+min*60*1000))}
function lockAdmin(){sessionStorage.removeItem(ADMIN_UNLOCK_KEY)}
function showPinModal(show){elPinOverlay.style.display=show?"flex":"none"; if(show){elPinInput.value=""; setTimeout(()=>elPinInput.focus(),120)}}
function requestAdminAccess(){showPinModal(true); location.hash="#/admin"}

function getRoute(){return location.hash||"#/gdl"}
function populateRouteSelect(){
  elRouteSelectMobile.innerHTML=`
    <option value="#/gdl">Guadalajara</option>
    <option value="#/mty">Monterrey</option>
    <option value="#/mex">México</option>
    <option value="#/admin">Admin</option>`;
}
function applyRoute(){
  currentRoute=getRoute();
  $$(".pill").forEach(p=>p.classList.toggle("active", p.getAttribute("data-route")===currentRoute));
  elRouteSelectMobile.value=currentRoute;

  if(currentRoute==="#/admin" && !getUnlocked()){
    elPageAdmin.classList.add("hide"); elPageCity.classList.remove("hide");
    showPinModal(true);
    return;
  }
  if(currentRoute==="#/admin"){
    elPageCity.classList.add("hide"); elPageAdmin.classList.remove("hide");
    renderAdmin(); return;
  }
  elPageAdmin.classList.add("hide"); elPageCity.classList.remove("hide");
  currentCityKey = currentRoute==="#/mty" ? "mty" : (currentRoute==="#/mex" ? "mex" : "gdl");
  renderCity();
}
function cityName(k){return k==="mex"?"México":(k==="mty"?"Monterrey":"Guadalajara")}
function renderSellerOptions(cityKey){
  const list=SELLERS[cityKey]||[];
  elSeller.innerHTML=list.map(n=>`<option>${escapeHtml(n)}</option>`).join("");
}
function renderCity(){
  $("#cityTitle").textContent=`Ciudad: ${cityName(currentCityKey)}`;
  renderSellerOptions(currentCityKey);
  if(!elDay.value) elDay.value=localDateKey(new Date());
  refreshHistory(); refreshActiveBox(); updateStatus();
}
function validateStart(){
  if(!elSeller.value) return "Selecciona vendedor.";
  if(!elClient.value.trim()) return "Escribe el cliente.";
  if(!elType.value) return "Selecciona tipo de visita.";
  return "";
}
function setActiveUI(isActive){elBtnStart.disabled=isActive; elBtnEnd.disabled=!isActive}
function refreshActiveBox(){
  const a=loadActive();
  if(!a){
    $("#activeState").textContent="Sin visita activa"; $("#activeMeta").textContent="—"; setActiveUI(false);
    if(activeTimer){clearInterval(activeTimer);activeTimer=null}
    return;
  }
  setActiveUI(true);
  const dur=Math.max(0,Math.round((Date.now()-a.start_ts_ms)/1000));
  $("#activeState").innerHTML=`<b>En curso</b> · ${escapeHtml(a.client)} · ${escapeHtml(a.type)}`;
  $("#activeMeta").textContent=`Inicio ${fmtTime(a.start_ts_ms)} · Duración ${fmtDur(dur)} · ${a.start_lat!=null?"GPS OK":"GPS …"}`;
  if(!activeTimer) activeTimer=setInterval(refreshActiveBox,1000);
}
function getGeo(options){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("Geolocalización no disponible"));
    navigator.geolocation.getCurrentPosition(p=>resolve(p),e=>reject(e), options||{enableHighAccuracy:true,timeout:12000,maximumAge:0});
  });
}
async function startVisit(){
  const msg=validateStart(); if(msg){toast("Falta",msg); return;}
  const startTs=Date.now();
  const active={
    local_id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())+"-"+Math.random().toString(16).slice(2)),
    device_id:getDeviceId(),
    city:currentCityKey,
    vendor:elSeller.value,
    client:elClient.value.trim(),
    type:elType.value,
    notes:elNotes.value.trim(),
    day_key:elDay.value||localDateKey(new Date()),
    start_ts_ms:startTs,
    start_ts:new Date(startTs).toISOString(),
    start_lat:null,start_lng:null
  };
  saveActive(active); refreshActiveBox(); toast("Visita","Iniciada. Obteniendo GPS…");
  try{
    const pos=await getGeo(); const a=loadActive(); if(!a) return;
    a.start_lat=pos.coords.latitude; a.start_lng=pos.coords.longitude;
    saveActive(a); refreshActiveBox();
  }catch(e){toast("GPS","No se pudo obtener ubicación. Puedes terminar igual.")}
}
async function endVisit(){
  const a=loadActive(); if(!a){toast("Falta","No hay visita activa."); return;}
  const endTs=Date.now(); let endLat=null,endLng=null;
  try{const pos=await getGeo(); endLat=pos.coords.latitude; endLng=pos.coords.longitude;}catch(e){}
  const rec={
    local_id:a.local_id, device_id:a.device_id, city:a.city, vendor:a.vendor, client:a.client, type:a.type, notes:a.notes,
    day_key:a.day_key, start_ts:a.start_ts, start_lat:a.start_lat, start_lng:a.start_lng,
    end_ts:new Date(endTs).toISOString(), end_lat:endLat, end_lng:endLng,
    duration_sec:Math.max(0,Math.round((endTs-a.start_ts_ms)/1000))
  };
  clearActive(); refreshActiveBox();
  const store=loadStore(); store.visits.push(rec); saveStore(store);
  refreshHistory(); toast("Visita","Guardada local. Enviando a Cloud…");
  const r=await upsertVisit(rec);
  if(r.ok){setLastSent(new Date().toISOString()); toast("Cloud","Enviado OK")}
  else{addPending(rec); toast("Cloud","No se pudo enviar. Quedó en pendientes.")}
  updateStatus();
}
function refreshHistory(){
  const store=loadStore(), day=elDay.value||localDateKey(new Date()), city=currentCityKey;
  const list=store.visits.filter(v=>v.day_key===day && v.city===city).sort((a,b)=>(b.start_ts||"").localeCompare(a.start_ts||""));
  $("#histSubtitle").textContent=`${cityName(city)} · ${day} · ${list.length} visita(s)`;
  $("#histList").innerHTML=list.length?list.map(v=>{
    const s=v.start_ts?Date.parse(v.start_ts):null, e=v.end_ts?Date.parse(v.end_ts):null;
    const dur=v.duration_sec ?? ((s&&e)?Math.round((e-s)/1000):null);
    return `
      <div class="item">
        <div class="itemTop">
          <div>
            <b>${escapeHtml(v.client)}</b>
            <div class="meta">${escapeHtml(v.vendor)} · ${escapeHtml(v.type)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:900;font-size:12px">${fmtTime(s)}</div>
            <div class="meta">${fmtDur(dur)}</div>
          </div>
        </div>
        ${v.notes?`<div class="meta" style="margin-top:8px">${escapeHtml(v.notes)}</div>`:""}
        <div class="links">
          ${mapsLink("Inicio",v.start_lat,v.start_lng)}
          ${mapsLink("Fin",v.end_lat,v.end_lng)}
        </div>
      </div>`;
  }).join(""):`<div class="note">Sin registros para este día.</div>`;
  const pins=list.map(v=>{
    const lat=(v.end_lat!=null?v.end_lat:v.start_lat), lng=(v.end_lng!=null?v.end_lng:v.start_lng);
    return {client:v.client,vendor:v.vendor,lat,lng};
  }).filter(p=>p.lat!=null && p.lng!=null);
  $("#pinsList").innerHTML=pins.length?pins.map(p=>`
    <div class="item">
      <b>${escapeHtml(p.client)}</b>
      <div class="meta">${escapeHtml(p.vendor)} · ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>
      <div class="links"><a class="link" href="https://www.google.com/maps?q=${p.lat},${p.lng}" target="_blank" rel="noopener">Abrir en Maps</a></div>
    </div>`).join(""):`<div class="note">Aún no hay pines con GPS para este día.</div>`;
}
function mapsLink(label,lat,lng){
  if(lat==null||lng==null) return `<span class="link" style="opacity:.55">${label}: sin GPS</span>`;
  return `<a class="link" href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener">${label} (Maps)</a>`;
}

function renderAdminSellerOptions(){
  const all=[...(SELLERS.gdl||[]),...(SELLERS.mty||[]),...(SELLERS.mex||[])];
  const uniq=Array.from(new Set(all)).sort((a,b)=>a.localeCompare(b));
  elAdmSeller.innerHTML=`<option value="ALL">Todos</option>`+uniq.map(n=>`<option>${escapeHtml(n)}</option>`).join("");
}
function withinRange(day,from,to){if(!day)return false; if(from && day<from) return false; if(to && day>to) return false; return true}
function renderAdmin(){
  renderAdminSellerOptions();
  const today=localDateKey(new Date()); if(!elAdmFrom.value) elAdmFrom.value=today; if(!elAdmTo.value) elAdmTo.value=today;
  applyAdminFilters(); updateStatus();
}
function applyAdminFilters(){
  const store=loadStore(), city=elAdmCity.value, seller=elAdmSeller.value, from=elAdmFrom.value, to=elAdmTo.value;
  const list=store.visits.filter(v=>{
    if(city!=="ALL" && v.city!==city) return false;
    if(seller!=="ALL" && v.vendor!==seller) return false;
    if(!withinRange(v.day_key,from,to)) return false;
    return true;
  }).sort((a,b)=>(b.start_ts||"").localeCompare(a.start_ts||""));
  elAdmSubtitle.textContent=`${list.length} registros · ${from||"—"} a ${to||"—"}`;
  elAdmList.innerHTML=list.length?list.map(v=>{
    const s=v.start_ts?Date.parse(v.start_ts):null, e=v.end_ts?Date.parse(v.end_ts):null;
    const dur=v.duration_sec ?? ((s&&e)?Math.round((e-s)/1000):null);
    const lat=(v.end_lat!=null?v.end_lat:v.start_lat), lng=(v.end_lng!=null?v.end_lng:v.start_lng);
    return `
      <div class="item">
        <div class="itemTop">
          <div>
            <b>${escapeHtml(v.client)}</b>
            <div class="meta">${escapeHtml(v.vendor)} · ${escapeHtml(cityName(v.city))} · ${escapeHtml(v.type)}</div>
            ${v.notes?`<div class="meta" style="margin-top:6px">${escapeHtml(v.notes)}</div>`:""}
          </div>
          <div style="text-align:right">
            <div style="font-weight:900;font-size:12px">${v.day_key||""}</div>
            <div class="meta">${fmtTime(s)} · ${fmtDur(dur)}</div>
          </div>
        </div>
        <div class="links"><a class="link" href="https://www.google.com/maps?q=${lat||0},${lng||0}" target="_blank" rel="noopener">Ver pin</a></div>
      </div>`;
  }).join(""):`<div class="note">Sin resultados con esos filtros.</div>`;
  elBtnOpenAllPins.onclick=()=>{
    const pins=list.map(v=>({lat:(v.end_lat!=null?v.end_lat:v.start_lat), lng:(v.end_lng!=null?v.end_lng:v.start_lng)})).filter(p=>p.lat!=null && p.lng!=null);
    if(!pins.length){toast("Mapa","No hay pines con GPS"); return;}
    window.open(`https://www.google.com/maps?q=${pins[0].lat},${pins[0].lng}`,"_blank","noopener");
    toast("Mapa",`Abrí 1 pin. Total con GPS: ${pins.length}`);
  };
}

function updateStatus(){
  const online=navigator.onLine, cfg=cloudConfigured(), pend=loadPending().length, last=getLastSent();
  elNetDot.className="dot "+(online?"good":"bad");
  elNetTitle.textContent=online?"Online":"Offline";
  elNetSubtitle.textContent=online?"Puedes registrar visitas. Si falla el envío, quedan pendientes.":"Sin internet. Todo se guarda local y se enviará al volver.";
  elCloudTag.textContent=cfg?"Cloud: configurado":"Cloud: sin configurar";
  elPendingTag.textContent=`Pendientes: ${pend}`;
  elLastTag.textContent=last?`Último envío: ${new Date(last).toLocaleString()}`:"Último envío: —";
}

async function init(){
  await ensureDefaultPin();
  populateRouteSelect();
  if(!location.hash) location.hash="#/gdl";
  elDay.value=localDateKey(new Date());

  $$(".pill").forEach(p=>p.addEventListener("click", ()=>location.hash=p.getAttribute("data-route")));
  elRouteSelectMobile.addEventListener("change", ()=>location.hash=elRouteSelectMobile.value);

  elFabAdmin.addEventListener("click", ()=>{ if(!getUnlocked()) requestAdminAccess(); else location.hash="#/admin" });

  elPinCancel.addEventListener("click", ()=>{showPinModal(false); if(location.hash==="#/admin") location.hash="#/"+currentCityKey;});
  elPinUnlock.addEventListener("click", async ()=>{
    const pin=(elPinInput.value||"").trim(); if(pin.length<4){toast("PIN","Mínimo 4 dígitos"); return;}
    const h=await sha256Hex(pin); const saved=localStorage.getItem(PIN_HASH_KEY)||"";
    if(h!==saved){toast("PIN","Incorrecto"); return;}
    setUnlocked(180); showPinModal(false); toast("Admin","Acceso concedido"); location.hash="#/admin";
  });

  elBtnStart.addEventListener("click", startVisit);
  elBtnEnd.addEventListener("click", endVisit);
  elBtnExample.addEventListener("click", ()=>{elClient.value="Ej. Sushi Beto"; elType.value="Visita de Seguimiento"; elNotes.value="Ejemplo: revisar faltantes y proponer nuevo producto."; toast("Ejemplo","Campos llenados");});
  elBtnSync.addEventListener("click", syncPending);
  elDay.addEventListener("change", refreshHistory);

  elBtnClearLocal.addEventListener("click", ()=>{
    if(!confirm("¿Eliminar historial local de este dispositivo?")) return;
    localStorage.removeItem(STORE_KEY); localStorage.removeItem(PENDING_KEY); clearActive();
    refreshHistory(); refreshActiveBox(); updateStatus(); toast("Local","Historial local eliminado.");
  });

  elBtnLock.addEventListener("click", ()=>{lockAdmin(); showPinModal(false); toast("Admin","Bloqueado"); location.hash="#/"+currentCityKey;});
  elBtnAdmApply.addEventListener("click", applyAdminFilters);
  elBtnExport.addEventListener("click", ()=>{
    const store=loadStore(); const blob=new Blob([JSON.stringify(store,null,2)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`visitas_local_${localDateKey(new Date())}.json`; a.click(); URL.revokeObjectURL(a.href);
  });
  elBtnResetPin.addEventListener("click", async ()=>{
    const p1=prompt("Nuevo PIN (mínimo 4 dígitos):"); if(!p1) return; if(p1.trim().length<4){toast("PIN","Mínimo 4 dígitos"); return;}
    localStorage.setItem(PIN_HASH_KEY, await sha256Hex(p1.trim())); toast("PIN","Actualizado");
  });

  window.addEventListener("online", updateStatus);
  window.addEventListener("offline", updateStatus);
  window.addEventListener("hashchange", applyRoute);

  refreshActiveBox();
  applyRoute();
  updateStatus();
}
init();
</script>
</body>
</html>
