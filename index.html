<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pedidos Toyo MX · Index</title>
  <style>
    :root{
      --blue:#0B4CCB;
      --bg:#F3F5F7;
      --card:#ffffff;
      --border:#D1D5DB;
      --text:#111827;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:28px;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;margin-bottom:18px}
    .header h1{margin:0;color:var(--blue);font-size:42px;letter-spacing:-.5px}
    .sub{margin-top:6px;color:var(--muted);font-size:16px}
    .badge{border:1px solid #c7dbff;color:var(--blue);padding:10px 16px;border-radius:999px;font-weight:800;background:#eef4ff;white-space:nowrap}
    .card{background:var(--card);border-radius:18px;padding:18px 18px 14px;margin:16px 0;box-shadow:0 10px 25px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.03)}
    .row{display:grid;grid-template-columns: 1.1fr .9fr;gap:14px;align-items:start}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:800;margin-bottom:8px;color:#0b3c91}
    input,select{width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);font-size:16px;background:#fff}
    .hint{margin-top:10px;color:var(--muted);font-size:14px;line-height:1.35}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;font-weight:800;cursor:pointer}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:#f1f5f9;border:1px solid #e5e7eb;font-weight:800}
    .grid3{display:grid;grid-template-columns: repeat(3,1fr);gap:14px}
    @media(max-width:980px){.grid3{grid-template-columns:1fr}}
    .vendorCard,.clientCard{
      border:1px solid #e5e7eb;border-radius:18px;background:#fff;
      padding:16px 16px;display:flex;justify-content:space-between;gap:12px;align-items:center;
    }
    .vendorTitle{font-size:18px;font-weight:900;margin:0}
    .vendorMeta{color:var(--muted);font-size:13px;margin-top:6px}
    .clientName{font-size:18px;font-weight:900;margin:0}
    .clientMeta{color:var(--muted);font-size:13px;margin-top:6px}
    .openBtn{padding:10px 14px;border-radius:14px;border:1px solid #c7dbff;background:#eef4ff;color:var(--blue);font-weight:900;cursor:pointer}
    .sectionTitle{font-size:26px;font-weight:950;margin:0 0 6px;color:#0b3c91}
    .sectionSub{margin:0 0 14px;color:var(--muted)}
    .rightTag{margin-left:auto}
    .tiny{font-size:12px;color:var(--muted)}
    .diag{display:none;margin-top:10px;border-top:1px dashed #d1d5db;padding-top:10px}
    .diag pre{white-space:pre-wrap;background:#0b1220;color:#e5e7eb;padding:12px;border-radius:12px;font-size:12px;overflow:auto}
    .warn{color:#b45309;font-weight:900}
    .ok{color:#166534;font-weight:900}
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>Pedidos Toyo MX</h1>
      <div class="sub">Selecciona vendedor o busca un cliente para abrir su HTML.</div>
    </div>
    <div class="badge">Versión corporativa</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Buscar cliente (nombre o código)</label>
        <input id="q" placeholder="Ej. ALTAMESE o C020669" autocomplete="off" />
        <div class="hint">Tip: puedes pegar el código de cliente. El resultado abre el HTML directo (GitHub Pages).</div>
        <div class="btnbar">
          <button class="btn" id="btnAll">Ver todos</button>
          <span class="pill" id="countClients">0 clientes</span>
        </div>
      </div>
      <div>
        <label>Filtrar por vendedor</label>
        <select id="vendorFilter">
          <option value="ALL">Todos</option>
        </select>
        <div class="hint">Nota: este index usa un archivo <b>clients.json</b> en la raíz del repo.</div>
        <div class="btnbar">
          <button class="btn" id="btnDiag">Ver diagnóstico</button>
          <span class="pill" id="countVendors">0 vendedores</span>
        </div>
      </div>
    </div>

    <div class="diag" id="diagBox">
      <div class="tiny"><span class="warn">Si ves error aquí</span>, es 100% por ruta/caché/permisos de GitHub Pages (no por tus HTML).</div>
      <pre id="diagText">Cargando…</pre>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between">
      <div>
        <div class="sectionTitle">Vendedores</div>
        <div class="sectionSub">Click en un vendedor para ver su lista.</div>
      </div>
      <span class="pill" id="vendorsShown">0 vendedores</span>
    </div>
    <div class="grid3" id="vendorsGrid"></div>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between">
      <div>
        <div class="sectionTitle">Clientes</div>
        <div class="sectionSub" id="clientsLabel">Mostrando: todos</div>
      </div>
      <span class="pill" id="clientsShown">0 mostrados</span>
    </div>
    <div class="grid3" id="clientsGrid"></div>
  </div>

  <div class="tiny">Tip rápido: si actualizas archivos y no se refleja, abre el sitio con <b>?v=2</b> (o incógnito) para romper caché.</div>
</div>

<script>
(() => {
  const $ = (q)=>document.querySelector(q);
  const q = $("#q");
  const vendorFilter = $("#vendorFilter");
  const vendorsGrid = $("#vendorsGrid");
  const clientsGrid = $("#clientsGrid");
  const countClients = $("#countClients");
  const countVendors = $("#countVendors");
  const vendorsShown = $("#vendorsShown");
  const clientsShown = $("#clientsShown");
  const clientsLabel = $("#clientsLabel");
  const btnAll = $("#btnAll");
  const btnDiag = $("#btnDiag");
  const diagBox = $("#diagBox");
  const diagText = $("#diagText");

  let ALL = [];
  let VENDORS = [];

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function setDiag(obj){
    const txt = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    diagText.textContent = txt;
  }

  async function loadClients(){
    // Cache-busting fuerte para GitHub Pages
    const url = "clients.json?v=" + Date.now();

    try{
      setDiag({status:"fetching", url});
      const res = await fetch(url, {cache:"no-store"});
      const text = await res.text();
      if(!res.ok){
        setDiag({status:"error", http:res.status, body:text.slice(0,500)});
        throw new Error("No se pudo cargar clients.json (" + res.status + ")");
      }
      let data;
      try{ data = JSON.parse(text); }
      catch(e){
        setDiag({status:"error", msg:"clients.json no es JSON válido", sample:text.slice(0,600)});
        throw e;
      }

      // Acepta ambos formatos:
      // 1) [ {...}, {...} ]
      // 2) { "clients": [ ... ] }
      const arr = Array.isArray(data) ? data : (Array.isArray(data.clients) ? data.clients : []);
      if(!arr.length){
        setDiag({status:"warn", msg:"Se cargó JSON pero viene vacío o con forma distinta", keys:Object.keys(data||{}).slice(0,20)});
      }else{
        setDiag({status:"ok", msg:"clients.json cargado", total:arr.length, sample:arr[0]});
      }

      // Limpieza mínima (por si viene raro)
      ALL = arr
        .filter(x=>x && x.path && x.vendor_folder)
        .map(x=>({
          vendor_folder: (x.vendor_folder||"").trim(),
          vendor_label: (x.vendor_label||x.vendor_folder||"").trim(),
          client_name: (x.client_name||"").trim(),
          client_code: (x.client_code||"").trim(),
          path: (x.path||"").trim()
        }));

      // Vendors
      const map = new Map();
      ALL.forEach(c=>{
        if(!map.has(c.vendor_folder)){
          map.set(c.vendor_folder, {folder:c.vendor_folder, label:c.vendor_label || c.vendor_folder, count:0});
        }
        map.get(c.vendor_folder).count++;
      });
      VENDORS = [...map.values()].sort((a,b)=>a.label.localeCompare(b.label, "es"));

      // Fill vendor filter
      vendorFilter.innerHTML = `<option value="ALL">Todos</option>` + VENDORS.map(v=>(
        `<option value="${esc(v.folder)}">${esc(v.label)} (${v.count})</option>`
      )).join("");

      countClients.textContent = `${ALL.length} clientes`;
      countVendors.textContent = `${VENDORS.length} vendedores`;

      renderVendors();
      renderClients();
    }catch(err){
      // deja el diagnóstico visible si falla
      diagBox.style.display = "block";
      setDiag({status:"fatal", error: (err && err.message) ? err.message : String(err)});
      countClients.textContent = `0 clientes`;
      countVendors.textContent = `0 vendedores`;
      vendorsGrid.innerHTML = `<div class="vendorCard"><div><p class="vendorTitle">No se pudo cargar clients.json</p><div class="vendorMeta">Abre el diagnóstico y revisa la ruta del JSON.</div></div></div>`;
      clientsGrid.innerHTML = `<div class="clientCard"><div><p class="clientName">Sin resultados</p><div class="clientMeta">clients.json no se cargó.</div></div></div>`;
    }
  }

  function getFiltered(){
    const text = (q.value||"").trim().toUpperCase();
    const vf = vendorFilter.value || "ALL";
    let list = ALL.slice();

    if(vf !== "ALL"){
      list = list.filter(c=>c.vendor_folder === vf);
      clientsLabel.textContent = "Mostrando: " + (VENDORS.find(v=>v.folder===vf)?.label || vf);
    }else{
      clientsLabel.textContent = "Mostrando: todos";
    }

    if(text){
      list = list.filter(c=>{
        return (c.client_name||"").toUpperCase().includes(text) ||
               (c.client_code||"").toUpperCase().includes(text);
      });
    }
    return list;
  }

  function renderVendors(){
    vendorsGrid.innerHTML = "";
    vendorsShown.textContent = `${VENDORS.length} vendedores`;

    if(!VENDORS.length){
      vendorsGrid.innerHTML = `<div class="vendorCard"><div><p class="vendorTitle">Sin vendedores</p><div class="vendorMeta">clients.json está vacío o no se cargó.</div></div></div>`;
      return;
    }

    VENDORS.forEach(v=>{
      const el = document.createElement("div");
      el.className = "vendorCard";
      el.innerHTML = `
        <div>
          <p class="vendorTitle">${esc(v.label)}</p>
          <div class="vendorMeta">${esc(v.folder)} · ${v.count} cliente(s)</div>
        </div>
        <button class="openBtn">Ver</button>
      `;
      el.querySelector("button").addEventListener("click", ()=>{
        vendorFilter.value = v.folder;
        q.value = "";
        renderClients();
        window.scrollTo({top: document.body.scrollHeight * 0.25, behavior:"smooth"});
      });
      vendorsGrid.appendChild(el);
    });
  }

  function renderClients(){
    const list = getFiltered();
    clientsGrid.innerHTML = "";
    clientsShown.textContent = `${list.length} mostrados`;

    if(!list.length){
      clientsGrid.innerHTML = `<div class="clientCard"><div><p class="clientName">Sin resultados</p><div class="clientMeta">Prueba otro nombre/código o cambia el vendedor.</div></div></div>`;
      return;
    }

    // limita para que sea rápido
    const MAX = 300;
    const view = list.slice(0, MAX);

    view.forEach(c=>{
      const el = document.createElement("div");
      el.className = "clientCard";
      el.innerHTML = `
        <div>
          <p class="clientName">${esc(c.client_name || "—")}</p>
          <div class="clientMeta">${esc(c.client_code || "—")} · ${esc(c.vendor_label || c.vendor_folder)}</div>
        </div>
        <button class="openBtn">Abrir</button>
      `;
      el.querySelector("button").addEventListener("click", ()=>{
        // Abre el HTML dentro del repo
        window.open(c.path, "_blank");
      });
      clientsGrid.appendChild(el);
    });

    if(list.length > MAX){
      const more = document.createElement("div");
      more.className = "clientCard";
      more.innerHTML = `
        <div>
          <p class="clientName">Mostrando ${MAX} de ${list.length}</p>
          <div class="clientMeta">Escribe más letras o filtra por vendedor para afinar.</div>
        </div>
      `;
      clientsGrid.appendChild(more);
    }
  }

  // Events
  q.addEventListener("input", ()=>renderClients());
  vendorFilter.addEventListener("change", ()=>renderClients());
  btnAll.addEventListener("click", ()=>{
    vendorFilter.value = "ALL";
    q.value = "";
    renderClients();
  });
  btnDiag.addEventListener("click", ()=>{
    diagBox.style.display = (diagBox.style.display==="block") ? "none" : "block";
  });

  // Start
  loadClients();
})();
</script>
</body>
</html>
