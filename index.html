<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>App Visitas - Toyo MX (Simple Ruta)</title>

  <!-- Leaflet (mapa sin API key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card: rgba(255,255,255,.86);
      --card2: rgba(255,255,255,.94);
      --text:#0f172a;
      --muted: rgba(15,23,42,.62);
      --line: rgba(15,23,42,.10);
      --shadow: 0 12px 32px rgba(15,23,42,.10);
      --shadow2: 0 8px 20px rgba(15,23,42,.10);
      --r:18px;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent: rgba(99,102,241,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.16), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(20,184,166,.12), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(246,247,251,.92), rgba(246,247,251,.55));
      border-bottom:1px solid var(--line);
    }
    .top{
      max-width:1020px; margin:0 auto;
      padding:12px 12px 10px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:flex-start; min-width:240px;}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(20,184,166,.95));
      box-shadow: var(--shadow2);
      flex:0 0 auto;
    }
    .brand h1{margin:0; font-size:15px; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .nav{display:flex; gap:10px; align-items:center; flex:1 1 auto; justify-content:flex-end; min-width:260px;}
    .routeSelect{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      font-weight:900;
      box-shadow: 0 8px 18px rgba(15,23,42,.08);
      appearance:none; -webkit-appearance:none;
      max-width:360px;
    }
    .statusBar{max-width:1020px; margin:0 auto; padding:0 12px 10px;}
    .statusCard{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.78);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      flex-wrap:wrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.18)}
    .dot.good{background:var(--good);box-shadow:0 0 0 4px rgba(22,163,74,.18)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(239,68,68,.14)}
    .statusLeft{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .statusText{font-size:12px;color:var(--muted)}
    .statusRight{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .tag{
      font-size:12px; font-weight:900;
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.84);
    }

    .wrap{max-width:1020px; margin:0 auto; padding:14px 12px 96px;}
    .grid{display:grid; grid-template-columns: 1.12fr .88fr; gap:14px; margin-top:12px;}
    @media(max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);
      background: var(--card);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
    }
    .hd h2{margin:0; font-size:14px}
    .hd p{margin:3px 0 0; font-size:12px; color:var(--muted)}
    .bd{padding:14px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px; resize:vertical}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:560px){.two{grid-template-columns:1fr}}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.90);
      padding:11px 12px;
      border-radius:14px;
      font-weight:900; font-size:13px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      user-select:none;
    }
    .btn.primary{border-color: rgba(99,102,241,.28); background: var(--accent);}
    .btn.good{border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.10);}
    .btn.bad{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10);}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}
    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(15,23,42,.16);
      background: rgba(255,255,255,.78);
      font-size:12px;
      color: rgba(15,23,42,.70);
    }
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--line);
      background: var(--card2);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
    }
    .itemTop{display:flex; gap:10px; align-items:flex-start; justify-content:space-between}
    .itemTop b{font-size:13px}
    .meta{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35}
    .links{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .link{
      font-size:12px; font-weight:900;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      text-decoration:none; color:var(--text);
    }
    .split{height:1px;background:var(--line);margin:12px 0}
    .mapBox{
      height:280px;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
      background:#fff;
    }
    .fabAdmin{
      position:fixed; right:14px; bottom:14px; z-index:9999;
      border:0; border-radius:999px;
      padding:12px 14px;
      font-weight:900;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
    }

    .overlay{
      position:fixed; inset:0; z-index:99999;
      background:rgba(2,6,23,.45);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(420px, 100%);
      border-radius: 22px;
      background: rgba(255,255,255,.94);
      border:1px solid rgba(255,255,255,.40);
      box-shadow: 0 28px 70px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modal .mhd{padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal .mhd h3{margin:0;font-size:14px}
    .modal .mhd p{margin:4px 0 0;font-size:12px;color:var(--muted)}
    .modal .mbd{padding:14px 16px}
    .modal .mft{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .hide{display:none}

    .toast{position:fixed;left:12px;right:12px;bottom:78px;z-index:100000;display:none;justify-content:center;pointer-events:none;}
    .toast .tcard{
      pointer-events:auto;
      max-width:1020px;width:100%;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.90);
      box-shadow:0 14px 30px rgba(2,6,23,.16);
      padding:10px 12px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .toast b{font-size:13px}
    .toast p{margin:2px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
    .toast .x{border:0;background:transparent;font-weight:900;cursor:pointer}
  </style>
</head>
<body>

<header>
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>App de Visitas (Simple)</h1>
        <p>1 solo <b>index.html</b> · enlaza puntos en mapa · sube a Supabase (simple)</p>
      </div>
    </div>

    <div class="nav">
      <select id="routeSelect" class="routeSelect" aria-label="Ciudad / Admin"></select>
    </div>
  </div>

  <div class="statusBar">
    <div class="statusCard">
      <div class="statusLeft">
        <div id="netDot" class="dot"></div>
        <div>
          <div style="font-weight:900;font-size:13px" id="netTitle">Estado</div>
          <div class="statusText" id="netSubtitle">—</div>
        </div>
      </div>
      <div class="statusRight">
        <div class="tag" id="cloudTag">Cloud: —</div>
        <div class="tag" id="pendingTag">Pendientes: 0</div>
        <div class="tag" id="lastTag">Último envío: —</div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="page-city">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h2 id="cityTitle">Ciudad</h2>
            <p>Selecciona vendedor → cliente → tipo → <b>Iniciar</b> → <b>Terminar</b>.</p>
          </div>
          <div class="btnrow" style="margin-top:0">
            <button class="btn" id="btnExample">Ejemplo</button>
            <button class="btn" id="btnSync">Sincronizar</button>
          </div>
        </div>
        <div class="bd">
          <label>Vendedor</label>
          <select id="seller"></select>

          <div class="two">
            <div>
              <label>Fecha (historial)</label>
              <input id="day" type="date"/>
            </div>
            <div>
              <label>Tipo de visita</label>
              <select id="vtype">
                <option value="">Selecciona…</option>
                <option>Degustación</option>
                <option>Entrega de faltantes</option>
                <option>Entrega de nuevos productos</option>
                <option>Visita Potencialidad</option>
                <option>Visita de Seguimiento</option>
                <option>Cobranza</option>
              </select>
            </div>
          </div>

          <label>Cliente a visitar</label>
          <input id="client" placeholder="Ej. Sushi Beto"/>

          <label>Comentarios</label>
          <textarea id="notes" placeholder="Notas: acuerdos, faltantes, próximos pasos…"></textarea>

          <div class="btnrow">
            <button class="btn good" id="btnStart">Iniciar visita</button>
            <button class="btn bad" id="btnEnd" disabled>Terminar visita</button>
          </div>

          <div class="note">
            <b>Visita activa:</b> <span id="activeState">Sin visita activa</span><br>
            <span class="statusText" id="activeMeta">—</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2>Historial del día + Ruta</h2>
            <p id="histSubtitle">—</p>
          </div>
          <div class="btnrow" style="margin-top:0">
            <button class="btn" id="btnOpenRoute">Abrir ruta (Google Maps)</button>
            <button class="btn" id="btnClearLocal">Limpiar local</button>
          </div>
        </div>
        <div class="bd">
          <div id="mapCity" class="mapBox"></div>
          <div class="split"></div>
          <div class="list" id="histList"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="page-admin" class="hide">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Admin (local)</h2>
            <p>Filtra y revisa lo que hay en <b>este dispositivo</b>.</p>
          </div>
          <div class="btnrow" style="margin-top:0">
            <button class="btn" id="btnLock">Bloquear</button>
            <button class="btn bad" id="btnResetPin">Cambiar PIN</button>
          </div>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <label>Ciudad</label>
              <select id="admCity">
                <option value="ALL">Todas</option>
                <option value="gdl">Guadalajara</option>
                <option value="mty">Monterrey</option>
                <option value="mex">México</option>
              </select>
            </div>
            <div>
              <label>Vendedor</label>
              <select id="admSeller"><option value="ALL">Todos</option></select>
            </div>
          </div>
          <div class="two">
            <div>
              <label>Desde</label>
              <input id="admFrom" type="date"/>
            </div>
            <div>
              <label>Hasta</label>
              <input id="admTo" type="date"/>
            </div>
          </div>
          <div class="btnrow">
            <button class="btn primary" id="btnAdmApply">Aplicar</button>
            <button class="btn" id="btnExport">Exportar JSON</button>
          </div>
          <div class="note">
            <b>Supabase (simple):</b> solo para “subir”. Sin RLS/policies.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2>Resultados + Ruta</h2>
            <p id="admSubtitle">—</p>
          </div>
          <div class="btnrow" style="margin-top:0">
            <button class="btn" id="btnAdmRoute">Abrir ruta (Google Maps)</button>
          </div>
        </div>
        <div class="bd">
          <div id="mapAdmin" class="mapBox"></div>
          <div class="split"></div>
          <div class="list" id="admList"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<button id="fabAdmin" class="fabAdmin">Admin</button>

<div id="pinOverlay" class="overlay">
  <div class="modal">
    <div class="mhd">
      <h3>Acceso Admin</h3>
      <p>Ingresa tu PIN para abrir Admin.</p>
    </div>
    <div class="mbd">
      <label>PIN</label>
      <input id="pinInput" type="password" inputmode="numeric" placeholder="••••">
      <div class="note">PIN por defecto: <b>1234</b></div>
    </div>
    <div class="mft">
      <button class="btn" id="pinCancel">Cancelar</button>
      <button class="btn primary" id="pinUnlock">Entrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="tcard">
    <div>
      <b id="toastTitle">—</b>
      <p id="toastMsg">—</p>
    </div>
    <button class="x" id="toastClose">✕</button>
  </div>
</div>

<script>
/* =============================
   CONFIG (PEGA AQUI TUS DATOS)
   ============================= */
const SUPABASE_PROJECT_URL = "https://cqgctmpbvlsodfnwscnx.supabase.co";
const SUPABASE_ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxZ2N0bXBidmxzb2RmbndzY254Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQyOTIsImV4cCI6MjA4MzMxMDI5Mn0.gSOhlIgGFo5cwimH6hJ_yk5lquVsxKxDGJLAR9dA5xM";
const SUPABASE_TABLE       = "visits";
/* ============================= */

const SELLERS = {
  mex: ["David Adrian Hernández Guzmán","Javier Espinosa Olivares","Ricardo Gutierrez Bandera","Abraham Rene Valdes Gonzales","Jesus Antonio Ramirez Rivera","Sergio Servin Rivera","Eduardo Faustino Hernandez Sanchez","Andres Fierro Ibañez","Tohru Kurasawa","Tanno Nobuko"],
  mty: ["Jessica Palomo","Luis Heredia","Carla Hernández"],
  gdl: ["Aguilar Neri Daniel","De la Cruz Ponce Julio Cesar","Garibay Ortiz Sergio Joel","Sierra de Anda Aldo","Perez Mar Alan Roberto","Reynoso Aguilar Maricela","Sandra Navarro Navarro","Aguirre Ojeda Arcenio","Velez Castellanos Antonio","Yepez Mora Oscar Alberto","Sanchez Esmeralda","Reynaga Valeria","González Guzmán Cristian Eduardo"]
};

const $=(q)=>document.querySelector(q);
function escapeHtml(s){ return String(s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
function safeJsonParse(s,f){ try{return JSON.parse(s)}catch(e){return f} }
function localDateKey(d){ const z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
function fmtTime(ts){ if(!ts) return "—"; const d=new Date(ts); return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`; }
function fmtDur(sec){ if(sec==null) return "—"; sec=Math.max(0,sec|0); const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60; return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`; }
function cityName(k){ return k==="mex"?"México":(k==="mty"?"Monterrey":"Guadalajara"); }

const STORE_KEY="toyo_visits_store_v2";
const ACTIVE_KEY="toyo_visits_active_v2";
const PENDING_KEY="toyo_visits_pending_v2";
const DEVICE_KEY="toyo_visits_device_v2";
const PIN_HASH_KEY="toyo_pin_hash_v2";
const ADMIN_UNLOCK_KEY="toyo_admin_unlock_v2";

function loadStore(){ return safeJsonParse(localStorage.getItem(STORE_KEY),{visits:[]}); }
function saveStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
function loadActive(){ return safeJsonParse(localStorage.getItem(ACTIVE_KEY), null); }
function saveActive(a){ localStorage.setItem(ACTIVE_KEY, JSON.stringify(a)); }
function clearActive(){ localStorage.removeItem(ACTIVE_KEY); }
function loadPending(){ return safeJsonParse(localStorage.getItem(PENDING_KEY), []); }
function savePending(l){ localStorage.setItem(PENDING_KEY, JSON.stringify(l)); }
function addPending(rec){ const l=loadPending(); l.push(rec); savePending(l); }
function shiftPending(){ const l=loadPending(); const x=l.shift(); savePending(l); return x; }

function getDeviceId(){
  let id=localStorage.getItem(DEVICE_KEY);
  if(!id){
    id=(crypto.randomUUID?crypto.randomUUID():String(Date.now())+"-"+Math.random().toString(16).slice(2));
    localStorage.setItem(DEVICE_KEY,id);
  }
  return id;
}
function setLastSent(iso){ localStorage.setItem("toyo_last_sent_v2", iso); }
function getLastSent(){ return localStorage.getItem("toyo_last_sent_v2")||""; }

const TOAST=$("#toast"), T_TITLE=$("#toastTitle"), T_MSG=$("#toastMsg");
$("#toastClose").addEventListener("click", ()=>TOAST.style.display="none");
function toast(t,m){ T_TITLE.textContent=t||"Info"; T_MSG.textContent=m||""; TOAST.style.display="flex"; setTimeout(()=>TOAST.style.display="none",3200); }

function cloudConfigured(){
  return !!(SUPABASE_PROJECT_URL && SUPABASE_ANON_KEY && !SUPABASE_PROJECT_URL.includes("PEGA_AQUI") && !SUPABASE_ANON_KEY.includes("PEGA_AQUI"));
}
function restUrl(p){ return SUPABASE_PROJECT_URL.replace(/\/$/,"")+p; }

async function pushToSupabase(rec){
  if(!cloudConfigured()) return {ok:false,msg:"Cloud sin configurar"};
  const url=restUrl(`/rest/v1/${encodeURIComponent(SUPABASE_TABLE)}`);
  const headers={
    "Content-Type":"application/json",
    "apikey": SUPABASE_ANON_KEY,
    "Authorization":"Bearer "+SUPABASE_ANON_KEY,
    "Prefer":"return=minimal"
  };
  const res=await fetch(url,{method:"POST",headers,body:JSON.stringify(rec)});
  if(res.ok) return {ok:true};
  let msg=`HTTP ${res.status}`;
  try{ const t=await res.text(); if(t && t.length<240) msg=t; }catch(e){}
  return {ok:false,msg};
}

async function syncPending(){
  if(!navigator.onLine){ toast("Offline","Sin internet. Pendientes quedan en cola."); updateStatus(); return; }
  if(!cloudConfigured()){ toast("Cloud","Pega Project URL + Anon Key en el index.html"); updateStatus(); return; }
  let ok=0, fail=0;
  for(let i=0;i<25;i++){
    const rec=loadPending()[0];
    if(!rec) break;
    const r=await pushToSupabase(rec);
    if(r.ok){ shiftPending(); ok++; setLastSent(new Date().toISOString()); }
    else{ fail++; break; }
  }
  toast("Cloud",`Sync: ${ok} OK · ${fail} fallaron`);
  updateStatus();
}

async function sha256Hex(msg){
  const enc=new TextEncoder().encode(msg);
  const buf=await crypto.subtle.digest("SHA-256",enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function ensureDefaultPin(){
  if(localStorage.getItem(PIN_HASH_KEY)) return;
  localStorage.setItem(PIN_HASH_KEY, await sha256Hex("1234"));
}
function getUnlocked(){ return Date.now() < parseInt(sessionStorage.getItem(ADMIN_UNLOCK_KEY)||"0",10); }
function setUnlocked(min){ sessionStorage.setItem(ADMIN_UNLOCK_KEY, String(Date.now()+min*60*1000)); }
function lockAdmin(){ sessionStorage.removeItem(ADMIN_UNLOCK_KEY); }

/* UI */
const elRouteSelect=$("#routeSelect");
const elCityTitle=$("#cityTitle");
const elSeller=$("#seller");
const elDay=$("#day");
const elClient=$("#client");
const elType=$("#vtype");
const elNotes=$("#notes");
const elBtnStart=$("#btnStart");
const elBtnEnd=$("#btnEnd");
const elBtnOpenRoute=$("#btnOpenRoute");
const elHistList=$("#histList");
const elHistSubtitle=$("#histSubtitle");
const elActiveState=$("#activeState");
const elActiveMeta=$("#activeMeta");
const elPageCity=$("#page-city");
const elPageAdmin=$("#page-admin");
const elFabAdmin=$("#fabAdmin");
const elPinOverlay=$("#pinOverlay");
const elPinInput=$("#pinInput");
const elPinCancel=$("#pinCancel");
const elPinUnlock=$("#pinUnlock");
const elAdmCity=$("#admCity");
const elAdmSeller=$("#admSeller");
const elAdmFrom=$("#admFrom");
const elAdmTo=$("#admTo");
const elAdmList=$("#admList");
const elAdmSubtitle=$("#admSubtitle");

const elNetDot=$("#netDot");
const elNetTitle=$("#netTitle");
const elNetSubtitle=$("#netSubtitle");
const elCloudTag=$("#cloudTag");
const elPendingTag=$("#pendingTag");
const elLastTag=$("#lastTag");

/* Leaflet maps */
let mapCity=null, mapAdmin=null, layerCity=null, layerAdmin=null;

function ensureLeafletReady(){
  return new Promise((resolve)=>{
    if(window.L) return resolve();
    const t0=Date.now();
    const it=setInterval(()=>{
      if(window.L){ clearInterval(it); resolve(); }
      if(Date.now()-t0>8000){ clearInterval(it); resolve(); }
    },50);
  });
}
async function initMaps(){
  await ensureLeafletReady();
  if(!window.L){
    $("#mapCity").innerHTML=`<div class="note">Mapa no disponible (sin internet / CDN). Usa “Abrir ruta”.</div>`;
    $("#mapAdmin").innerHTML=`<div class="note">Mapa no disponible (sin internet / CDN). Usa “Abrir ruta”.</div>`;
    return;
  }
  mapCity=L.map("mapCity",{zoomControl:true});
  mapAdmin=L.map("mapAdmin",{zoomControl:true});
  const tiles=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap"});
  tiles.addTo(mapCity);
  tiles.clone().addTo(mapAdmin);
  layerCity=L.layerGroup().addTo(mapCity);
  layerAdmin=L.layerGroup().addTo(mapAdmin);
  mapCity.setView([20.6736,-103.344],11);
  mapAdmin.setView([23.6345,-102.5528],5);
}
function pointsFromVisits(visits){
  const sorted=[...visits].sort((a,b)=>(a.start_ts||"").localeCompare(b.start_ts||""));
  const pts=[];
  for(const v of sorted){
    const lat=(v.end_lat!=null?v.end_lat:v.start_lat);
    const lng=(v.end_lng!=null?v.end_lng:v.start_lng);
    if(lat==null||lng==null) continue;
    pts.push({lat,lng,label:`${v.client} · ${v.vendor} · ${v.type}`});
  }
  const out=[];
  for(const p of pts){
    const last=out[out.length-1];
    if(last && Math.abs(last.lat-p.lat)<1e-7 && Math.abs(last.lng-p.lng)<1e-7) continue;
    out.push(p);
  }
  return out;
}
function drawRoute(map, layer, visits){
  if(!map || !layer || !window.L) return;
  layer.clearLayers();
  const pts=pointsFromVisits(visits);
  if(!pts.length) return;
  const latlngs=pts.map(p=>[p.lat,p.lng]);
  pts.forEach((p,idx)=>{
    const m=L.marker([p.lat,p.lng]).addTo(layer);
    m.bindPopup(`<b>${idx+1}</b> · ${escapeHtml(p.label)}<br>${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`);
  });
  const line=L.polyline(latlngs,{weight:4,opacity:0.85}).addTo(layer);
  map.fitBounds(line.getBounds(),{padding:[18,18]});
}
function openRouteInGoogleMaps(visits){
  const pts=pointsFromVisits(visits);
  if(pts.length<2){ toast("Ruta","Necesitas al menos 2 puntos con GPS."); return; }
  const cut=pts.slice(0,10);
  const parts=cut.map(p=>`${p.lat},${p.lng}`);
  const url="https://www.google.com/maps/dir/"+parts.join("/");
  window.open(url,"_blank","noopener");
}

let currentRoute="#/gdl";
let currentCityKey="gdl";
let activeTimer=null;

function renderRouteSelect(){
  elRouteSelect.innerHTML = `<option value="#/gdl">Guadalajara</option><option value="#/mty">Monterrey</option><option value="#/mex">México</option><option value="#/admin">Admin</option>`;
}
function getRoute(){ const h=location.hash||"#/gdl"; return h.split("?")[0]||"#/gdl"; }
function renderSellerOptions(cityKey){
  const list=SELLERS[cityKey]||[];
  elSeller.innerHTML=list.map(n=>`<option>${escapeHtml(n)}</option>`).join("");
}

function refreshActiveBox(){
  const a=loadActive();
  if(!a){
    elActiveState.textContent="Sin visita activa";
    elActiveMeta.textContent="—";
    elBtnStart.disabled=false;
    elBtnEnd.disabled=true;
    if(activeTimer){ clearInterval(activeTimer); activeTimer=null; }
    return;
  }
  elBtnStart.disabled=true;
  elBtnEnd.disabled=false;
  const dur=Math.max(0,Math.round((Date.now()-a.start_ts_ms)/1000));
  elActiveState.innerHTML=`<b>En curso</b> · ${escapeHtml(a.client)} · ${escapeHtml(a.type)}`;
  elActiveMeta.textContent=`Inicio ${fmtTime(a.start_ts_ms)} · Duración ${fmtDur(dur)} · ${a.start_lat!=null?"GPS OK":"GPS …"}`;
  if(!activeTimer) activeTimer=setInterval(refreshActiveBox,1000);
}
function getGeo(options){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("Geolocalización no disponible"));
    navigator.geolocation.getCurrentPosition(p=>resolve(p),e=>reject(e),options||{enableHighAccuracy:true,timeout:12000,maximumAge:0});
  });
}
function validateStart(){
  if(!elSeller.value) return "Selecciona vendedor.";
  if(!elClient.value.trim()) return "Escribe el cliente.";
  if(!elType.value) return "Selecciona tipo de visita.";
  return "";
}
async function startVisit(){
  const msg=validateStart();
  if(msg){ toast("Falta",msg); return; }
  const startTs=Date.now();
  const active={
    local_id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())+"-"+Math.random().toString(16).slice(2)),
    device_id:getDeviceId(),
    city:currentCityKey,
    vendor:elSeller.value,
    client:elClient.value.trim(),
    type:elType.value,
    notes:elNotes.value.trim(),
    day_key:elDay.value||localDateKey(new Date()),
    start_ts_ms:startTs,
    start_ts:new Date(startTs).toISOString(),
    start_lat:null,start_lng:null
  };
  saveActive(active);
  refreshActiveBox();
  toast("Visita","Iniciada. Obteniendo GPS…");
  try{
    const pos=await getGeo();
    const a=loadActive(); if(!a) return;
    a.start_lat=pos.coords.latitude;
    a.start_lng=pos.coords.longitude;
    saveActive(a);
    refreshActiveBox();
  }catch(e){
    toast("GPS","No se pudo obtener ubicación. Puedes terminar igual.");
  }
}
async function endVisit(){
  const a=loadActive();
  if(!a){ toast("Falta","No hay visita activa."); return; }
  const endTs=Date.now();
  let endLat=null,endLng=null;
  try{
    const pos=await getGeo();
    endLat=pos.coords.latitude;
    endLng=pos.coords.longitude;
  }catch(e){}
  const rec={
    local_id:a.local_id,
    device_id:a.device_id,
    city:a.city,
    vendor:a.vendor,
    client:a.client,
    type:a.type,
    notes:a.notes,
    day_key:a.day_key,
    start_ts:a.start_ts,
    start_lat:a.start_lat,
    start_lng:a.start_lng,
    end_ts:new Date(endTs).toISOString(),
    end_lat:endLat,
    end_lng:endLng,
    duration_sec:Math.max(0,Math.round((endTs-a.start_ts_ms)/1000))
  };
  clearActive();
  refreshActiveBox();
  const store=loadStore();
  store.visits.push(rec);
  saveStore(store);
  refreshHistoryAndMap();
  toast("Visita","Guardada local. Subiendo…");
  if(navigator.onLine && cloudConfigured()){
    const r=await pushToSupabase(rec);
    if(r.ok){ setLastSent(new Date().toISOString()); toast("Cloud","Enviado OK"); }
    else{ addPending(rec); toast("Cloud","Falló el envío. Quedó en pendientes."); }
  }else{
    addPending(rec);
    toast("Cloud","Offline o sin configurar. Quedó en pendientes.");
  }
  updateStatus();
}
function getCityDayVisits(){
  const store=loadStore();
  const day=elDay.value||localDateKey(new Date());
  return store.visits.filter(v=>v.city===currentCityKey && v.day_key===day);
}
function mapsLink(label,lat,lng){
  if(lat==null||lng==null) return `<span class="link" style="opacity:.55">${label}: sin GPS</span>`;
  return `<a class="link" href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener">${label}</a>`;
}
function refreshHistoryAndMap(){
  const day=elDay.value||localDateKey(new Date());
  const list=getCityDayVisits().sort((a,b)=>(b.start_ts||"").localeCompare(a.start_ts||""));
  elHistSubtitle.textContent=`${cityName(currentCityKey)} · ${day} · ${list.length} visita(s)`;
  elHistList.innerHTML=list.length?list.map(v=>{
    const s=v.start_ts?Date.parse(v.start_ts):null;
    return `<div class="item">
      <div class="itemTop">
        <div>
          <b>${escapeHtml(v.client)}</b>
          <div class="meta">${escapeHtml(v.vendor)} · ${escapeHtml(v.type)}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:900;font-size:12px">${fmtTime(s)}</div>
          <div class="meta">${fmtDur(v.duration_sec)}</div>
        </div>
      </div>
      ${v.notes?`<div class="meta" style="margin-top:8px">${escapeHtml(v.notes)}</div>`:""}
      <div class="links">
        ${mapsLink("Inicio",v.start_lat,v.start_lng)}
        ${mapsLink("Fin",v.end_lat,v.end_lng)}
      </div>
    </div>`;
  }).join(""):`<div class="note">Sin registros para este día.</div>`;
  drawRoute(mapCity, layerCity, list);
}

/* Admin local */
function renderAdminSellerOptions(){
  const all=[...(SELLERS.gdl||[]),...(SELLERS.mty||[]),...(SELLERS.mex||[])];
  const uniq=Array.from(new Set(all)).sort((a,b)=>a.localeCompare(b));
  elAdmSeller.innerHTML=`<option value="ALL">Todos</option>` + uniq.map(n=>`<option>${escapeHtml(n)}</option>`).join("");
}
function withinRange(day,from,to){
  if(!day) return false;
  if(from && day<from) return false;
  if(to && day>to) return false;
  return true;
}
function getAdminFiltered(){
  const store=loadStore();
  const city=elAdmCity.value;
  const seller=elAdmSeller.value;
  const from=elAdmFrom.value;
  const to=elAdmTo.value;
  return store.visits.filter(v=>{
    if(city!=="ALL" && v.city!==city) return false;
    if(seller!=="ALL" && v.vendor!==seller) return false;
    if(!withinRange(v.day_key,from,to)) return false;
    return true;
  }).sort((a,b)=>(a.start_ts||"").localeCompare(b.start_ts||""));
}
function applyAdminFilters(){
  const list=getAdminFiltered();
  elAdmSubtitle.textContent=`${list.length} registros · ${elAdmFrom.value||"—"} a ${elAdmTo.value||"—"}`;
  elAdmList.innerHTML=list.length?list.slice().reverse().map(v=>{
    const s=v.start_ts?Date.parse(v.start_ts):null;
    const lat=(v.end_lat!=null?v.end_lat:v.start_lat);
    const lng=(v.end_lng!=null?v.end_lng:v.start_lng);
    return `<div class="item">
      <div class="itemTop">
        <div>
          <b>${escapeHtml(v.client)}</b>
          <div class="meta">${escapeHtml(v.vendor)} · ${escapeHtml(cityName(v.city))} · ${escapeHtml(v.type)}</div>
          ${v.notes?`<div class="meta" style="margin-top:6px">${escapeHtml(v.notes)}</div>`:""}
        </div>
        <div style="text-align:right">
          <div style="font-weight:900;font-size:12px">${v.day_key||""}</div>
          <div class="meta">${fmtTime(s)} · ${fmtDur(v.duration_sec)}</div>
        </div>
      </div>
      <div class="links">
        ${mapsLink("Pin",lat,lng)}
      </div>
    </div>`;
  }).join(""):`<div class="note">Sin resultados con esos filtros.</div>`;
  drawRoute(mapAdmin, layerAdmin, list);
}
function exportLocalJson(){
  const store=loadStore();
  const blob=new Blob([JSON.stringify(store,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`visitas_local_${localDateKey(new Date())}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* Routing */
function showPinModal(show){
  elPinOverlay.style.display=show?"flex":"none";
  if(show){ elPinInput.value=""; setTimeout(()=>elPinInput.focus(),120); }
}
function requestAdminAccess(){ showPinModal(true); location.hash="#/admin"; }

function applyRoute(){
  currentRoute=getRoute();
  elRouteSelect.value=currentRoute;

  if(currentRoute==="#/admin" && !getUnlocked()){
    elPageAdmin.classList.add("hide");
    elPageCity.classList.remove("hide");
    showPinModal(true);
    return;
  }
  if(currentRoute==="#/admin"){
    elPageCity.classList.add("hide");
    elPageAdmin.classList.remove("hide");
    renderAdminSellerOptions();
    applyAdminFilters();
    updateStatus();
    return;
  }
  elPageAdmin.classList.add("hide");
  elPageCity.classList.remove("hide");
  currentCityKey = currentRoute==="#/mty" ? "mty" : (currentRoute==="#/mex" ? "mex" : "gdl");
  elCityTitle.textContent=`Ciudad: ${cityName(currentCityKey)}`;
  renderSellerOptions(currentCityKey);
  if(!elDay.value) elDay.value=localDateKey(new Date());
  refreshHistoryAndMap();
  refreshActiveBox();
  updateStatus();
}

/* Status */
function updateStatus(){
  const online=navigator.onLine;
  const cfg=cloudConfigured();
  const pend=loadPending().length;
  const last=getLastSent();

  elNetDot.className="dot "+(online?"good":"bad");
  elNetTitle.textContent=online?"Online":"Offline";
  elNetSubtitle.textContent=online?"Puedes registrar visitas. Si falla el envío, quedan en pendientes.":"Sin internet. Todo se guarda local y se enviará al volver.";
  elCloudTag.textContent=cfg?"Cloud: configurado":"Cloud: sin configurar";
  elPendingTag.textContent=`Pendientes: ${pend}`;
  elLastTag.textContent=last?`Último envío: ${new Date(last).toLocaleString()}`:"Último envío: —";
}

/* Init */
async function init(){
  await ensureDefaultPin();
  renderRouteSelect();
  elDay.value=localDateKey(new Date());

  initMaps().then(()=>{ refreshHistoryAndMap(); applyAdminFilters(); });

  elRouteSelect.addEventListener("change", ()=>location.hash=elRouteSelect.value);
  window.addEventListener("hashchange", applyRoute);

  $("#btnSync").addEventListener("click", syncPending);
  $("#btnExample").addEventListener("click", ()=>{ elClient.value="Ej. Sushi Beto"; elType.value="Visita de Seguimiento"; elNotes.value="Ejemplo: revisar faltantes y proponer nuevo producto."; toast("Ejemplo","Campos llenados"); });
  elBtnStart.addEventListener("click", startVisit);
  elBtnEnd.addEventListener("click", endVisit);
  elDay.addEventListener("change", refreshHistoryAndMap);

  elBtnOpenRoute.addEventListener("click", ()=>openRouteInGoogleMaps(getCityDayVisits()));

  $("#btnClearLocal").addEventListener("click", ()=>{
    if(!confirm("¿Eliminar historial local de este dispositivo?")) return;
    localStorage.removeItem(STORE_KEY);
    localStorage.removeItem(PENDING_KEY);
    clearActive();
    refreshHistoryAndMap();
    refreshActiveBox();
    updateStatus();
    toast("Local","Historial local eliminado.");
  });

  $("#btnAdmApply").addEventListener("click", applyAdminFilters);
  $("#btnAdmRoute").addEventListener("click", ()=>openRouteInGoogleMaps(getAdminFiltered()));
  $("#btnExport").addEventListener("click", exportLocalJson);
  $("#btnLock").addEventListener("click", ()=>{ lockAdmin(); showPinModal(false); toast("Admin","Bloqueado"); location.hash="#/"+currentCityKey; });
  $("#btnResetPin").addEventListener("click", async ()=>{ const p=prompt("Nuevo PIN (mínimo 4 dígitos):"); if(!p) return; if(p.trim().length<4){toast("PIN","Mínimo 4 dígitos"); return;} localStorage.setItem(PIN_HASH_KEY, await sha256Hex(p.trim())); toast("PIN","Actualizado"); });

  elFabAdmin.addEventListener("click", ()=>{ if(!getUnlocked()) requestAdminAccess(); else location.hash="#/admin"; });

  elPinCancel.addEventListener("click", ()=>{ showPinModal(false); if(location.hash==="#/admin") location.hash="#/"+currentCityKey; });
  elPinUnlock.addEventListener("click", async ()=>{
    const pin=(elPinInput.value||"").trim();
    if(pin.length<4){ toast("PIN","Mínimo 4 dígitos"); return; }
    const h=await sha256Hex(pin);
    const saved=localStorage.getItem(PIN_HASH_KEY)||"";
    if(h!==saved){ toast("PIN","Incorrecto"); return; }
    setUnlocked(180);
    showPinModal(false);
    toast("Admin","Acceso concedido");
    location.hash="#/admin";
  });

  window.addEventListener("online", ()=>{ updateStatus(); syncPending(); });
  window.addEventListener("offline", updateStatus);

  if(!location.hash) location.hash="#/gdl";
  applyRoute();
  refreshActiveBox();
  updateStatus();
}
init();
</script>
</body>
</html>
